@namespace Masa.Stack.Components.Layouts
@inherits MasaComponentBase
@implements IDisposable
@inject GlobalConfig GlobalConfig

<MNavigationDrawer App
                   Class="navigation"
                   Permanent
                   MiniVariantWidth="96"
                   Width="300"
                   MiniVariant="GlobalConfig.Mini">

    <div style="height:96px;margin-left:28px"
         class="d-flex align-center">
        @if (GlobalConfig.Mini)
        {
            <img height="40" width="40" src="@MiniLogo" alt="mini_log" />
        }
        else
        {
            <img width="200" src="@Logo" alt="logo" />
        }
    </div>

    <MDivider />

    <MList Nav Linkage Class="pa-6">
        @foreach (var nav in Items!)
        {
            if (!nav.HasChildren)
            {
                <MTooltip Right Disabled="!GlobalConfig.Mini" ContentClass="default-emphasis-secondary rounded-2" ContentStyle="border:1px solid #E2E7F4;">
                    <ActivatorContent Context="tooltipContext">
                        <DefaultListItem Medium Class="mb-2 rounded-3" ActiveClass="primary" Href="@nav.Url" @attributes="@tooltipContext.Attrs">
                            <ItemContent>
                                <MListItemIcon>
                                    <MIcon Dense Style="margin-left:6px" Color="@(context.Active ? "white" : "default-text-regular-secondary")">@nav.Icon</MIcon>
                                </MListItemIcon>
                                <MListItemContent>
                                    <div class="ml-1 text-truncate @(context.Active ? "white--text" : "default-text-regular-secondary")">
                                        @T(nav.Name)
                                    </div>
                                </MListItemContent>
                            </ItemContent>
                        </DefaultListItem>
                    </ActivatorContent>
                    <ChildContent>
                        @T(nav.Name)
                    </ChildContent>
                </MTooltip>
            }
            else
            {
                <MMenu Disabled="!GlobalConfig.Mini" OffsetY OpenOnHover CloseOnContentClick="false" ContentClass="white">
                    <ActivatorContent Context="menuContext">
                        <MListGroup Group="@GenGroup(nav.Children)"
                                    NoAction
                                    ActiveClass="primary--text"
                                    AppendIcon="mdi-menu-down">
                            <ActivatorContent>
                                <MListItemContent>
                                    <div class="text-truncate default-text-regular-secondary">@T(nav.Name)</div>
                                </MListItemContent>
                            </ActivatorContent>
                            <PrependIconContent>
                                <MIcon Dense Style="min-width: 36px" @attributes="@menuContext.Attrs">@nav.Icon</MIcon>
                            </PrependIconContent>
                            <ChildContent>
                                <NavItems Data="@nav"></NavItems>
                            </ChildContent>
                        </MListGroup>
                    </ActivatorContent>
                    <ChildContent>
                        <MList Nav Linkage>
                            <NavItems Data="@nav"></NavItems>
                        </MList>
                    </ChildContent>
                </MMenu>
            }
        }
    </MList>
</MNavigationDrawer>

<DefaultButton Icon
               Medium
               Class="nav-trigger white"
               Style="@($"{(GlobalConfig.Mini ? "left:76px;" : "left:280px;")}")"
               OnClick="() => GlobalConfig.Mini = !GlobalConfig.Mini">
    <MIcon Color="primary">
        @(GlobalConfig.Mini ? "mdi-chevron-right" : "mdi-chevron-left")
    </MIcon>
</DefaultButton>

@code {

    [Parameter]
    public string? DefaultRoute { get; set; }

    [EditorRequired]
    [Parameter]
    public List<Nav>? Items { get; set; }

    [EditorRequired]
    [Parameter]
    public string? Logo { get; set; }

    [EditorRequired]
    [Parameter]
    public string? MiniLogo { get; set; }

    protected override void OnInitialized()
    {
        GlobalConfig.OnLanguageChanged += StateHasChanged;

        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        Items ??= new List<Nav>();
    }

    private List<string> GenGroup(List<Nav> navs)
    {
        if (!navs.Any())
        {
            return new List<string>();
        }

        List<string> groups = new();

        foreach (var menu in navs)
        {
            groups.AddRange(GenGroup(menu.Children));

            if (string.IsNullOrEmpty(menu.Url)) continue;

            groups.Add(menu.Url);
        }

        return groups;
    }

    public void Dispose()
    {
        GlobalConfig.OnLanguageChanged -= StateHasChanged;
    }

}
