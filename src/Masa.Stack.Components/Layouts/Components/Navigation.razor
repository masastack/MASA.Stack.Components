@namespace Masa.Stack.Components.Layouts
@inherits MasaComponentBase
@implements IDisposable
@inject GlobalConfig GlobalConfig

<MNavigationDrawer App
                   Class="navigation"
                   Permanent
                   MiniVariantWidth="96"
                   Width="300"
                   @bind-MiniVariant="GlobalConfig.Mini">

    <div style="height:96px;margin-left:28px"
         class="d-flex align-center">
        @if (GlobalConfig.Mini)
        {
            <img height="40" width="40" src="@MiniLogo" alt="mini_log" />
        }
        else
        {
            <img width="200" src="@Logo" alt="logo" />
        }
    </div>

    <MDivider />

    <MList Nav Linkage Class="pa-6">
        @foreach (var nav in Items!)
        {
            if (!nav.HasChildren)
            {
                <DefaultListItem Medium Class="mb-2" ActiveClass="primary" Href="@nav.Url">
                    <ItemContent>
                        <MListItemIcon>
                            <MIcon Small Class="ml-2" Color="@(context.Active ? "white" : "default-text-regular-secondary")">@nav.Icon</MIcon>
                        </MListItemIcon>
                        <MListItemContent>
                            <div class="ml-1 text-truncate @(context.Active ? "white--text" : "default-text-regular-secondary")">
                                @T(nav.Name)
                            </div>
                        </MListItemContent>
                    </ItemContent>
                </DefaultListItem>
            }
            else
            {
                <MListGroup Group="@GenGroup(nav.Children)"
                            NoAction
                            ActiveClass="primary--text"
                            AppendIcon="mdi-menu-down">
                    <ActivatorContent>
                        <MListItemContent>
                            <div class="text-truncate default-text-regular-secondary">@T(nav.Name)</div>
                        </MListItemContent>
                    </ActivatorContent>
                    <PrependIconContent>
                        <MIcon Small Style="min-width: 36px">@nav.Icon</MIcon>
                    </PrependIconContent>
                    <ChildContent>
                        @foreach (var subNav in nav.Children)
                        {
                            @if (subNav.HasChildren)
                            {
                                <div class="d-flex align-star ml-6" style="position: relative">
                                    <img src="./_content/Masa.Stack.Components/img/nav-sub-line.png" width="18" height="48" alt="line" />
                                    <MListGroup Group="@GenGroup(subNav.Children)"
                                                Class="full-width"
                                                ActiveClass="primary--text"
                                                AppendIcon="mdi-menu-down">
                                        <ActivatorContent>
                                            <MListItemContent>
                                                <div class="text-truncate default-text-regular-secondary">@T(subNav.Name)</div>
                                            </MListItemContent>
                                        </ActivatorContent>
                                        <ChildContent>
                                            @foreach (var lastNav in subNav.Children)
                                            {
                                                <div class="d-flex align-center">
                                                    <img src="./_content/Masa.Stack.Components/img/nav-sub-sub-line.png" height="48" alt="line" 
                                                         style="position: absolute;left: 0;"/>
                                                    <DefaultListItem Medium Class="mb-0" ActiveClass="primary" Link Href="@lastNav.Url">
                                                        <ItemContent>
                                                            <MListItemContent>
                                                                <div class="text-truncate ml-3 @(context.Active ? "white--text" : "text-btn default-lighten-2--text")">
                                                                    @T(lastNav.Name)
                                                                </div>
                                                            </MListItemContent>
                                                        </ItemContent>
                                                    </DefaultListItem>
                                                </div>
                                            }
                                        </ChildContent>
                                    </MListGroup>
                                </div>
                            }
                            else
                            {
                                if (nav.Children.IndexOf(subNav) == 0)
                                {
                                    <div class="d-flex align-center ml-6">
                                        <img src="./_content/Masa.Stack.Components/img/nav-first-sub-before.png" height="8"
                                             alt="first-sub-before" />
                                    </div>
                                }

                                <div class="d-flex align-center ml-6">
                                    <img src="./_content/Masa.Stack.Components/img/nav-sub-line.png" width="18" height="48" alt="line" />

                                    <DefaultListItem Medium Class="mb-0" ActiveClass="primary" Link Href="@subNav.Url">
                                        <ItemContent>
                                            <MListItemContent>
                                                <div class="text-truncate ml-3 @(context.Active ? "white--text" : "text-btn default-lighten-2--text")">
                                                    @T(subNav.Name)
                                                </div>
                                            </MListItemContent>
                                        </ItemContent>
                                    </DefaultListItem>
                                </div>
                            }
                        }
                    </ChildContent>
                </MListGroup>
            }
        }
    </MList>
</MNavigationDrawer>

<DefaultButton Icon
               Medium
               Class="nav-trigger white"
               Style="@($"{(GlobalConfig.Mini ? "left:76px;" : "left:280px;")}")"
               OnClick="() => GlobalConfig.Mini = !GlobalConfig.Mini">
    <MIcon Color="primary">
        @(GlobalConfig.Mini ? "mdi-chevron-right" : "mdi-chevron-left")
    </MIcon>
</DefaultButton>

@code {

    [Parameter]
    public string? DefaultRoute { get; set; }

    [EditorRequired]
    [Parameter]
    public List<Nav>? Items { get; set; }

    [EditorRequired]
    [Parameter]
    public string? Logo { get; set; }

    [EditorRequired]
    [Parameter]
    public string? MiniLogo { get; set; }

    protected override void OnInitialized()
    {
        GlobalConfig.OnLanguageChanged += StateHasChanged;

        base.OnInitialized();
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();

        Items ??= new List<Nav>();
    }
    
    private List<string> GenGroup(List<Nav> navs)
    {
        if (!navs.Any())
        {
            return new List<string>();
        }

        List<string> groups = new();

        foreach (var menu in navs)
        {
            groups.AddRange(GenGroup(menu.Children));

            if (string.IsNullOrEmpty(menu.Url)) continue;

            groups.Add(menu.Url);
        }

        return groups;
    }

    public void Dispose()
    {
        GlobalConfig.OnLanguageChanged -= StateHasChanged;
    }

}
