@namespace Masa.Stack.Components

<MDialog Value="Value"
         ValueChanged="ValueChanged"
         Persistent="_persistent"
         Class="pa-6"
         ContentClass="pa-6 white br-5"
         Width="400">
    <div class="d-flex my-@Size" style="flex-direction: column;justify-content: center;align-items: center;">
        @if (!string.IsNullOrWhiteSpace(IconOfTitle))
        {
            <span class="primary d-flex mb-3"
                  style="height: 52px;width: 52px;border-radius: 50%;align-items: center;justify-content: center;border: 4px solid #ECE8FF !important;">
                <MIcon Color="white">@IconOfTitle</MIcon>
            </span>
        }

        <span class="font-20-bold emphasis2--text">
            @Title
        </span>
    </div>

    <div class="py-@Size">
        @ChildContent
    </div>

    @if (OnOk.HasDelegate)
    {
        <div class="d-flex my-@Size" style="align-items: center;justify-content: space-around">
            <MButton Color="primary" Large="!Dense" Outlined Rounded Width="140" OnClick="HandleOnCancel">@CancelText</MButton>
            <MButton Color="primary" Large="!Dense" Disabled="OkDisabled" Loading="@_okLoading" Rounded Width="140" OnClick="HandleOnOk">@OkText</MButton>
        </div>
    }
</MDialog>

@code {

    [Parameter]
    public bool Value { get; set; }

    [Parameter]
    public EventCallback<bool> ValueChanged { get; set; }

    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    [Parameter]
    public string? IconOfTitle { get; set; }

    [Parameter, EditorRequired]
    public string Title { get; set; }

    [Parameter]
    public bool Dense { get; set; }

    [Parameter]
    public string? CancelText { get; set; } = "Cancel";

    [Parameter]
    public string? OkText { get; set; } = "Ok";

    [Parameter]
    public bool OkDisabled { get; set; }

    [Parameter]
    public EventCallback OnCancel { get; set; }

    [Parameter]
    public EventCallback OnOk { get; set; }

    private int Size => Dense ? 4 : 6;

    private bool _okLoading;
    private bool _persistent;

    protected override void OnParametersSet()
    {
        if (OnOk.HasDelegate)
        {
            _persistent = true;
        }
    }

    private async Task HandleOnCancel()
    {
        if (OnCancel.HasDelegate)
        {
            await OnCancel.InvokeAsync();
        }

        await UpdateValue(false);
    }

    private async Task HandleOnOk()
    {
        if (OnOk.HasDelegate)
        {
            _okLoading = true;

            await OnOk.InvokeAsync();

            _okLoading = false;
        }
    }

    private async Task UpdateValue(bool val)
    {
        if (ValueChanged.HasDelegate)
        {
            await ValueChanged.InvokeAsync(val);
        }
        else
        {
            Value = val;
        }
    }

}
